// ==UserScript==
// @name         å…¨å¹³å°è§†é¢‘å…¨å±å¤§å¸ˆProï¼ˆç¨³å®šä¼˜åŒ–ç‰ˆï¼‰
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  æ™ºèƒ½å…¨å±æ§åˆ¶ï¼Œæ”¯æŒåŠ¨æ€å®šä½ä¸æ™ºèƒ½éšè—ï¼Œä¼˜åŒ–å…¨å±å›¾æ ‡UIï¼Œè§£å†³é‡å¤æ˜¾ç¤ºå’Œé®æŒ¡é—®é¢˜
// @match        *://*.douyin.com/*
// @grant        GM_addStyle
// @grant        GM_registerMenuCommand
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // é…ç½®é¡¹ï¼šæŒ‰é’®ä½ç½®ã€é€æ˜åº¦ã€è‡ªåŠ¨éšè—ã€å›¾æ ‡å¤§å°ã€å›¾æ ‡é¢œè‰²ã€å›¾æ ‡é˜´å½±
    const CONFIG = {
        POSITION: GM_getValue('btn_position', 'right'),
        OPACITY: GM_getValue('btn_opacity', 0.8),
        AUTO_HIDE: GM_getValue('auto_hide', true),
        ICON_SIZE: GM_getValue('icon_size', '70%'),       // å›¾æ ‡å¤§å°ï¼ˆç™¾åˆ†æ¯”ï¼Œç›¸å¯¹äºæŒ‰é’®å°ºå¯¸ï¼‰
        ICON_COLOR: GM_getValue('icon_color', '#ffffff'),  // å›¾æ ‡é¢œè‰²
        ICON_SHADOW: GM_getValue('icon_shadow', 'drop-shadow(0px 0px 3px rgba(0,0,0,0.6))') // å›¾æ ‡é˜´å½±æ•ˆæœ
    };

    // è§†é¢‘æ£€æµ‹å™¨ç±»ï¼šç›‘æ§é¡µé¢ä¸­æ–°å¢çš„ video æ ‡ç­¾ï¼Œå¹¶ä¸ºæ¯ä¸ªè§†é¢‘åˆ›å»ºæ§åˆ¶å™¨
    class VideoDetector {
        constructor() {
            this.videoMap = new WeakMap(); // è®°å½•å·²å¤„ç†è§†é¢‘ï¼Œé¿å…é‡å¤æ·»åŠ 
            this.initObserver();
        }

        // åˆå§‹åŒ– DOM è§‚å¯Ÿå™¨ï¼Œç›‘æ§æ–°å¢çš„ video å…ƒç´ 
        initObserver() {
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.tagName === 'VIDEO') {
                            this.processVideo(node);
                        }
                        if (node.querySelectorAll) {
                            node.querySelectorAll('video').forEach(video => {
                                this.processVideo(video);
                            });
                        }
                    });
                });
            });
            observer.observe(document, {
                subtree: true,
                childList: true
            });
            // å¤„ç†é¡µé¢ä¸­å·²æœ‰çš„è§†é¢‘
            document.querySelectorAll('video').forEach(video => {
                this.processVideo(video);
            });
        }

        // å¯¹å•ä¸ª video å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–è§†é¢‘æ§åˆ¶å™¨
        processVideo(video) {
            if (!this.videoMap.has(video)) {
                const controller = new VideoController(video);
                this.videoMap.set(video, controller);
                controller.init();
            }
        }
    }

    // è§†é¢‘æ§åˆ¶å™¨ç±»ï¼šè´Ÿè´£æ§åˆ¶å…¨å±ã€æŒ‰é’®æ˜¾ç¤ºã€å®šä½ä¸éšè—é€»è¾‘
    class VideoController {
        constructor(videoElement) {
            this.video = videoElement;
            this.container = this.findVideoContainer();
            this.btn = null;        // å…¨å±æ§åˆ¶æŒ‰é’®
            this.hideTimer = null;  // æŒ‰é’®è‡ªåŠ¨éšè—å®šæ—¶å™¨
            this.handleFullscreenChangeBound = this.handleFullscreenChange.bind(this);
            this.showButtonBound = this.showButton.bind(this);
        }

        // æŸ¥æ‰¾è§†é¢‘å®¹å™¨ï¼Œä¼˜å…ˆä½¿ç”¨å¸¸è§çš„æ’­æ”¾å™¨å®¹å™¨ï¼Œå¦åˆ™ä½¿ç”¨ video çš„çˆ¶å…ƒç´ 
        findVideoContainer() {
            return this.video.closest([
                '.video-container',
                '.player-wrapper',
                '[data-video-player]',
                'div > video:only-child'
            ].join(',')) || this.video.parentElement;
        }

        // åˆå§‹åŒ–ï¼šè®¾ç½®å®¹å™¨å®šä½ã€åˆ›å»ºæŒ‰é’®ã€ç»‘å®šäº‹ä»¶ã€è®¾ç½®ä½ç½®ä¸æ ·å¼
        init() {
            // ç¡®ä¿å®¹å™¨å®šä½æ­£ç¡®ï¼ˆä¾¿äºç»å¯¹å®šä½æŒ‰é’®æ˜¾ç¤ºåœ¨å®¹å™¨å†…ï¼‰
            if (window.getComputedStyle(this.container).position === 'static') {
                this.container.style.position = 'relative';
            }
            this.createButton();
            this.bindEvents();
            this.autoPosition();
            this.setButtonStyle();
        }

        // åˆ›å»ºå…¨å±æ§åˆ¶æŒ‰é’®ï¼Œè‹¥å·²å­˜åœ¨åŒç±»æŒ‰é’®åˆ™ä¸é‡å¤åˆ›å»º
        createButton() {
            if (this.container.querySelector('.universal-fullscreen-btn')) return;
            this.btn = document.createElement('div');
            this.btn.className = 'universal-fullscreen-btn';
            // ä¼˜åŒ–åçš„ SVG å›¾æ ‡ï¼Œç°ä»£ç®€æ´é£æ ¼
            this.btn.innerHTML = `
                <svg class="expand-icon" viewBox="0 0 24 24">
                    <polyline points="4,10 4,4 10,4" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="14,4 20,4 20,10" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="20,14 20,20 14,20" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="10,20 4,20 4,14" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                </svg>
                <svg class="collapse-icon" viewBox="0 0 24 24">
                    <polyline points="10,4 4,4 4,10" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="14,4 20,4 20,10" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="14,20 20,20 20,14" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                    <polyline points="10,20 4,20 4,14" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke-width="2"/>
                </svg>
            `;
            this.container.appendChild(this.btn);
        }

        // ç»‘å®šäº¤äº’äº‹ä»¶ï¼ŒåŒ…æ‹¬ç‚¹å‡»ã€åŒå‡»ã€é¼ æ ‡ç§»åŠ¨ã€çª—å£å°ºå¯¸å˜åŒ–ç­‰
        bindEvents() {
            // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢å…¨å±
            this.btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleFullscreen();
            });
            // åŒå‡»è§†é¢‘åˆ‡æ¢å…¨å±
            this.video.addEventListener('dblclick', () => this.toggleFullscreen());

            // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼ˆæ ‡å‡†åŠ Webkit å‰ç¼€ï¼‰
            document.addEventListener('fullscreenchange', this.handleFullscreenChangeBound);
            document.addEventListener('webkitfullscreenchange', this.handleFullscreenChangeBound);

            // è‹¥å¯ç”¨è‡ªåŠ¨éšè—ï¼Œåˆ™ç»‘å®šé¼ æ ‡ç§»åŠ¨ä¸ç¦»å¼€äº‹ä»¶
            if (CONFIG.AUTO_HIDE) {
                this.container.addEventListener('mousemove', this.showButtonBound);
                this.container.addEventListener('mouseleave', () => {
                    if (!document.fullscreenElement) {
                        this.startHideTimer();
                    }
                });
                // è§¦æ‘¸è®¾å¤‡æ”¯æŒï¼šå•ç‚¹è§¦æ‘¸æ—¶æ˜¾ç¤ºæŒ‰é’®
                this.container.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) this.showButtonBound();
                }, {passive: true});
            }

            // å…¨å±çŠ¶æ€ä¸‹ç‚¹å‡»å®¹å™¨æ—¶æ˜¾ç¤ºæŒ‰é’®
            this.container.addEventListener('click', () => {
                if (document.fullscreenElement) this.showButtonBound();
            });

            // çª—å£å°ºå¯¸å˜åŒ–æ—¶é‡æ–°å®šä½æŒ‰é’®å¹¶æ˜¾ç¤º
            window.addEventListener('resize', () => {
                this.autoPosition();
                this.showButtonBound();
            });
        }

        // åˆ‡æ¢å…¨å±çŠ¶æ€ï¼šè‹¥å·²å…¨å±åˆ™é€€å‡ºï¼Œå¦åˆ™è¯·æ±‚å…¨å±
        toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                const requestMethod = [
                    'requestFullscreen',
                    'webkitRequestFullscreen',
                    'mozRequestFullScreen',
                    'msRequestFullscreen'
                ].find(method => this.container[method]);
                if (requestMethod) {
                    this.container[requestMethod]();
                }
            }
        }

        // å¤„ç†å…¨å±çŠ¶æ€å˜åŒ–ï¼šæ›´æ–°æŒ‰é’®ä½ç½®ã€å›¾æ ‡æ˜¾ç¤ºä»¥åŠæŒ‰é’®é€æ˜åº¦
        handleFullscreenChange() {
            this.autoPosition();
            this.updateButtonIcon();
            this.showButtonBound();
            if (!document.fullscreenElement) {
                this.btn.style.opacity = CONFIG.OPACITY;
            }
        }

        // æ ¹æ®å…¨å±çŠ¶æ€å’Œå®¹å™¨å°ºå¯¸è‡ªåŠ¨è°ƒæ•´æŒ‰é’®ä½ç½®
        autoPosition() {
            const isFullscreen = document.fullscreenElement === this.container;
            const viewportRatio = window.innerWidth / window.innerHeight;
            if (isFullscreen) {
                this.btn.style[CONFIG.POSITION] = '20px';
                this.btn.style.bottom = viewportRatio > 1.77 ? '20px' : '30px';
            } else {
                const rect = this.container.getBoundingClientRect();
                const isVertical = rect.height > rect.width;
                this.btn.style[CONFIG.POSITION] = '10px';
                this.btn.style.bottom = isVertical ? '60px' : '20px';
            }
        }

        // è®¾ç½®æŒ‰é’®æ ·å¼ï¼Œä¼˜åŒ– SVG å›¾æ ‡ UIï¼šæ— èƒŒæ™¯ã€æ— æ¯›ç»ç’ƒï¼Œæ·»åŠ é˜´å½±æ•ˆæœï¼Œå¹¶æå‡å±‚çº§
        setButtonStyle() {
            Object.assign(this.btn.style, {
                opacity: CONFIG.OPACITY,
                transition: 'opacity 0.3s, transform 0.2s',
                cursor: 'pointer',
                position: 'absolute',
                zIndex: 99999,
                width: '32px',
                height: '32px',
                borderRadius: '8px'
            });
            // è®¾ç½® SVG å›¾æ ‡æ ·å¼ï¼Œå…è®¸è‡ªå®šä¹‰å¤§å°ã€é¢œè‰²åŠé˜´å½±
            this.btn.querySelectorAll('svg').forEach(icon => {
                Object.assign(icon.style, {
                    width: CONFIG.ICON_SIZE,
                    height: CONFIG.ICON_SIZE,
                    stroke: CONFIG.ICON_COLOR,
                    fill: 'none',
                    filter: CONFIG.ICON_SHADOW,
                    transition: 'opacity 0.3s, stroke 0.3s'
                });
            });
        }

        // æ˜¾ç¤ºæŒ‰é’®å¹¶æ¸…é™¤è‡ªåŠ¨éšè—å®šæ—¶å™¨
        showButton() {
            clearTimeout(this.hideTimer);
            this.btn.style.opacity = CONFIG.OPACITY;
            this.updateButtonIcon();
            if (document.fullscreenElement && CONFIG.AUTO_HIDE) {
                this.hideTimer = setTimeout(() => {
                    this.btn.style.opacity = '0';
                }, 1000);
            }
        }

        // æ›´æ–°æŒ‰é’®å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€ï¼šå…¨å±æ—¶æ˜¾ç¤ºé€€å‡ºå›¾æ ‡ï¼Œå¦åˆ™æ˜¾ç¤ºè¿›å…¥å›¾æ ‡
        updateButtonIcon() {
            const isFullscreen = document.fullscreenElement;
            this.btn.querySelector('.expand-icon').style.opacity = isFullscreen ? '0' : '1';
            this.btn.querySelector('.collapse-icon').style.opacity = isFullscreen ? '1' : '0';
        }

        // å¯åŠ¨è‡ªåŠ¨éšè—å®šæ—¶å™¨ï¼Œéå…¨å±çŠ¶æ€ä¸‹2ç§’åéšè—æŒ‰é’®
        startHideTimer() {
            if (!document.fullscreenElement) {
                this.hideTimer = setTimeout(() => {
                    this.btn.style.opacity = '0';
                }, 2000);
            }
        }
    }

    // æ·»åŠ å…¨å±€ CSS æ ·å¼
    GM_addStyle(`
        .universal-fullscreen-btn {
            transition: opacity 0.3s, transform 0.2s !important;
            transform-origin: center;
        }
        .universal-fullscreen-btn:hover {
            transform: scale(1.1);
        }
        :fullscreen .universal-fullscreen-btn {
            bottom: 20px !important;
            right: 20px !important;
        }
        @media (max-width: 768px) {
            .universal-fullscreen-btn {
                width: 40px !important;
                height: 40px !important;
                bottom: 70px !important;
            }
            :fullscreen .universal-fullscreen-btn {
                bottom: 30px !important;
                right: 30px !important;
            }
        }
    `);

    // æ³¨å†Œæ²¹çŒ´èœå•å‘½ä»¤

    // è®¾ç½®æŒ‰é’®ä½ç½®ï¼ˆleft/rightï¼‰
    GM_registerMenuCommand('âš™ï¸ è®¾ç½®æŒ‰é’®ä½ç½®', () => {
        const pos = prompt('è¯·è¾“å…¥æŒ‰é’®ä½ç½® (left/right):', CONFIG.POSITION);
        if (['left', 'right'].includes(pos)) {
            GM_setValue('btn_position', pos);
            location.reload();
        }
    });

    // è®¾ç½®æŒ‰é’®é€æ˜åº¦ï¼ˆ0.1-1ä¹‹é—´ï¼‰
    GM_registerMenuCommand('ğŸšï¸ è®¾ç½®é€æ˜åº¦ (0.1-1)', () => {
        const opacity = parseFloat(prompt('è¯·è¾“å…¥é€æ˜åº¦ (0.1-1):', CONFIG.OPACITY));
        if (!isNaN(opacity) && opacity >= 0.1 && opacity <= 1) {
            GM_setValue('btn_opacity', opacity);
            location.reload();
        }
    });

    // åˆ‡æ¢è‡ªåŠ¨éšè—åŠŸèƒ½
    GM_registerMenuCommand(`${CONFIG.AUTO_HIDE ? 'ğŸ”´' : 'ğŸŸ¢'} è‡ªåŠ¨éšè—`, () => {
        GM_setValue('auto_hide', !CONFIG.AUTO_HIDE);
        location.reload();
    });

    // è®¾ç½®å›¾æ ‡é¢œè‰²
    GM_registerMenuCommand('ğŸ¨ è®¾ç½®å›¾æ ‡é¢œè‰²', () => {
        const color = prompt('è¯·è¾“å…¥å›¾æ ‡é¢œè‰²ï¼ˆä¾‹å¦‚ #ffffffï¼‰:', CONFIG.ICON_COLOR);
        if (color) {
            GM_setValue('icon_color', color);
            location.reload();
        }
    });

    // è®¾ç½®å›¾æ ‡å¤§å°ï¼ˆç™¾åˆ†æ¯”ï¼Œç›¸å¯¹äºæŒ‰é’®å°ºå¯¸ï¼‰
    GM_registerMenuCommand('ğŸ”§ è®¾ç½®å›¾æ ‡å¤§å° (ç™¾åˆ†æ¯”)', () => {
        const size = prompt('è¯·è¾“å…¥å›¾æ ‡å¤§å°ç™¾åˆ†æ¯” (ä¾‹å¦‚ 70%):', CONFIG.ICON_SIZE);
        if (size) {
            GM_setValue('icon_size', size);
            location.reload();
        }
    });

    // è®¾ç½®å›¾æ ‡é˜´å½±æ•ˆæœ
    GM_registerMenuCommand('ğŸŒ‘ è®¾ç½®å›¾æ ‡é˜´å½±', () => {
        const shadow = prompt('è¯·è¾“å…¥å›¾æ ‡é˜´å½±æ•ˆæœ (ä¾‹å¦‚ drop-shadow(0px 0px 3px rgba(0,0,0,0.6))):', CONFIG.ICON_SHADOW);
        if (shadow) {
            GM_setValue('icon_shadow', shadow);
            location.reload();
        }
    });

    // åˆå§‹åŒ–è§†é¢‘æ£€æµ‹å™¨ï¼Œå¼€å§‹ç›‘æ§é¡µé¢ä¸­ video å…ƒç´ 
    new VideoDetector();
})();
